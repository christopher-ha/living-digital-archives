import Head from "next/head";
import styles from "@/styles/pages/Home.module.scss";
import { Canvas, useFrame, useLoader } from "@react-three/fiber";
import { useEffect, useRef, useState } from "react";
import Experience from "@/components/Experience";

function Home({ data }) {
  const { posts } = data.response;
  const [filteredPosts, setFilteredPosts] = useState([]);
  console.log(data);

  const extractFirstTumblrUrl = (string) => {
    // Use a regular expression to find the first url in the string that
    // starts with "https://64.media.tumblr.com/"
    const regex = /https:\/\/64\.media\.tumblr\.com\/[^\s]+/;
    const matches = string.match(regex);
    if (matches && matches.length > 0) {
      // Remove any quotation mark at the end of the first match
      const url = matches[0].replace(/\"$/, "");
      // Return the url without the quotation mark
      return url;
    } else {
      // Return null if no match is found
      return null;
    }
  };

  useEffect(() => {
    let data = [];

    posts.map((post, i) => {
      if (post.type === "photo") {
        data.push({
          key: i,
          id: post.id_string,
          timestamp: post.timestamp,
          image: post.photos[0].original_size.url,
          summary: post.summary,
          url: post.short_url,
        });
      } else if (post.type === "text") {
        data.push({
          key: i,
          id: post.id_string,
          timestamp: post.timestamp,
          image: extractFirstTumblrUrl(post.body),
          summary: post.summary,
          url: post.short_url,
        });
      }
    });

    setFilteredPosts(data);
  }, [posts]);

  console.log(filteredPosts);

  return (
    <div className={styles.container}>
      <Head>
        <title>𝓁𝒾𝓋𝒾𝓃𝑔 𝒹𝒾𝑔𝒾𝓉𝒶𝓁 𝒶𝓇𝒸𝒽𝒾𝓋𝑒𝓈</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <div className={styles.overlay}>
        <p>
          One Terabyte of Kilobyte Age is a project by artists Olia Lialina and
          Dragan Espenschied that is centered around the preservation and
          restoration of websites from GeoCities, the early internet&apos;s
          agora of vernacular design. Screenshots are automatically generated
          from a stash of old Geocities home pages, rescued by the Archive Team
          in 2009. The files are processed from oldest to newest.
        </p>
      </div>

      <footer className={styles.footer}>
        <div className={styles.credits}>
          <p>Design & Development @bhris001</p>
        </div>

        <form className={styles.input}>
          <input placeholder="Paste your Tumblr URL"></input>
          <button></button>
        </form>
      </footer>

      <div className={styles.scene}>
        <Canvas className={styles.canvas} shadows={true}>
          <Experience filteredPosts={filteredPosts} />
        </Canvas>
      </div>
    </div>
  );
}

// This gets called on every request
export async function getServerSideProps() {
  // Fetch data from external API
  const res = await fetch(
    `https://api.tumblr.com/v2/blog/vallllentina.tumblr.com/posts/photo?api_key=${process.env.API_KEY}&limit=50`
  );
  const data = await res.json();

  // Pass data to the page via props
  return { props: { data } };
}

export default Home;
